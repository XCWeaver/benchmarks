# TrainTicket / XCWeaver

Implementation of the [TrainTicket](https://github.com/FudanSELab/train-ticket) benchmark using [XCWeaver](https://github.com/XCWeaver/xcweaver). Drawing inspiration from the [Blueprint](https://gitlab.mpi-sws.org/cld/blueprint)'s repository.

# Table of Contents
- [TrainTicket @ XCWeaver](#trainticket--xcweaver)
- [Table of Contents](#table-of-contents)
- [1. Requirements](#1-requirements)
  - [1.1. Install Python Dependencies](#11-install-python-dependencies)
- [2. Configuration](#2-configuration)
  - [2.1. GCP Configuration](#21-gcp-configuration)
- [3. Application Deployment](#3-application-deployment)
  - [3.1. GCP Deployment](#31-gcp-deployment)
  - [3.2. Running Locally with XCWeaver in Multi Process](#32-running-locally-with-xcweaver-in-multi-process)
  - [3.3. Running Locally with XCWeaver in kube deployer with minikube](#33-running-locally-with-xcweaver-in-kube-deployer-with-minikube)
- [4. Complementary Information](#4-complementary-information)
  - [4.1. Manual Testing HTTP Requests on local machine](#41-manual-testing-http-requests-on-local-machine)
  - [4.2. Manual Testing HTTP Requests on GCP or minikube](#42-manual-testing-http-requests-on-gcp-or-minikube)


# 1. Requirements

- [Terraform >= v1.6.6](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)
- [Ansible >= v2.15.2](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
- [GCloud Cli](https://cloud.google.com/sdk/docs/install)
- [Golang >= 1.21](https://go.dev/doc/install)
```zsh
# install Golang v1.21.5
sudo wget https://go.dev/dl/go1.21.5.linux-amd64.tar.gz
sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.go/bin' >> ~/.bashrc
source ~/.bashrc
```
- [XCWeraver >= v0.0.6](https://github.com/XCWeaver/xcweaver)
```zsh
# install XCWeaver 0.0.6
go install github.com/XCWeaver/xcweaver/cmd/xcweaver@v0.0.6
```
- [XCWeaver kube deployer >= v0.0.12](https://github.com/XCWeaver/xcweaver-kube)
```zsh
# install XCWeaver-kube 0.0.12
go install github.com/XCWeaver/xcweaver-kube/cmd/xcweaver-kube@v0.0.12
```



## 1.1. Install Python Dependencies

Install python packages to use the `manager.py` script:
```zsh
pip install -r requirements.txt
```

# 2. Configuration

## 2.1. GCP Configuration

1. Ensure that you have a GCP project created and setup as your default project in `gcloud cli`:
``` zsh
# initialize gcloud (set default region e.g. as europe-west3-a)
gcloud init
# list all projects
gcloud projects list
# select the desired project id
gcloud config set project YOUR_PROJECT_ID
# verify it is now set as default
gcloud config get-value project
```
1. Ensure that [Compute Engine API](https://console.cloud.google.com/marketplace/product/google/compute.googleapis.com) is enabled in GCP
2. Go to `tese/xcweaver/trainticket/gcp/config.yml` and place you GCP `project_id` and any desired `username` for accessing GCP machines using that hostname
3. Configure GCP firewalls and SSH keys for Compute Engine
``` zsh
./manager.py configure --gcp
```
4. Setup a new Service Account key for authenticating (for more information: https://developers.google.com/workspace/guides/create-credentials)
    - Go to [IAM & Admin -> Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts) of your project
    - Select your compute engine default service account
    - Go to the keys tab and select `ADD KEY` to create a new key in JSON
    - Place your JSON file as `credentials.json` in `tese/xcweaver/trainticket/gcp/credentials.json`

# 3. Application Deployment

## 3.1. GCP Deployment

Use the following commands to deploy the wrk2 GCP machine and display info for host of GCP machine:
``` zsh
./manager.py deploy --gcp
```

Create a Kubernetes cluster and connect to it:
``` zsh
./manager.py cluster --gcp
```

Use the following commands to use the kube deployer to generate the Kubernetes manifest file and deploy the application to the Kubernetes cluster:
``` zsh
go build
xcweaver kube deploy config.yaml
kubectl apply -f <file>
```
> **_NOTE:_**  On the kubectl command replace file by the name of the Kubernetes manifest file automatically generated by the previous command

Run workload and automatically gather metrics to `evaluation` directory. If not specified, the default parameters are 2 threads, 2 clients, 30 duration (in seconds), 50 rate, localhost
``` zsh
./manager.py wrk2 --gcp -t THREADS -c CLIENTS -d DURATION -r RATE -ht HOST
./manager.py wrk2 --gcp
```

> **_NOTE:_**  It will be generated a file inside evaluation/gcp that contains the metrics


Otherwise, to clean all gcp resources at the end, do:

``` zsh
./manager.py clean --gcp
```

## 3.2. Running Locally with XCWeaver in Multi Process


Deploy and run application:
``` zsh
go generate
go build
xcweaver multi deploy weaver-local.toml
```

Run workload and gather metrics:

``` zsh
./manager.py wrk2 --local
```

> **_NOTE:_**  It will be generated a file inside evaluation/local that contains the metrics

Gather metrics:
``` zsh
./manager.py metrics --local
```

## 3.3. Running Locally with XCWeaver in kube deployer with minikube

Start minikube:
``` zsh
minikube start
minikube tunnel
```

Use the following commands to use the kube deployer to generate the Kubernetes manifest file and deploy the application to the Kubernetes cluster:
``` zsh
go build
xcweaver kube deploy config.yaml
kubectl apply -f <file>
```
> **_NOTE:_**  On the kubectl command replace file by the name of the Kubernetes manifest file automatically generated by the previous command

Run workload and automatically gather metrics to `evaluation` directory. If not specified, the default parameters are 2 threads, 2 clients, 30 duration (in seconds), 50 rate, localhost
``` zsh
./manager.py wrk2-kube --local -t THREADS -c CLIENTS -d DURATION -r RATE -ht HOST
./manager.py wrk2-kube --local
```

> **_NOTE:_**  It will be generated a file inside evaluation/local that contains the metrics

# 4. Complementary Information

## 4.1. Manual Testing HTTP Requests on local machine

**Cancel Ticket**: {token, orderId, loginId}

``` zsh
curl -X POST "localhost:9000/wrk2-api/user/cancelTicket" -d "token=TOKEN&orderId=ORDER_ID&loginId=LOGIN_ID"

# e.g.
curl -X POST "localhost:9000/wrk2-api/user/cancelTicket" -d "token=TOKEN&orderId=0&loginId=LOGIN_ID"
```

## 4.2. Manual Testing HTTP Requests on GCP or minikube

**Cancel Ticket**: {token, orderId, loginId}

``` zsh
curl -X POST "{host}/wrk2-api/user/cancelTicket" -d "token=TOKEN&orderId=ORDER_ID&loginId=LOGIN_ID"

# e.g.
curl -X POST "localhost/wrk2-api/user/cancelTicket" -d "token=TOKEN&orderId=0&loginId=LOGIN_ID"
```